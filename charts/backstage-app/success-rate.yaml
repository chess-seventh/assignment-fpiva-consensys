apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: cpu-success-rate
spec:
  args:
    - name: podname
  metrics:
    - name: success-rate
      initialDelay: 60s
      interval: 20s
      successCondition: result[0] < 4.5
      provider:
        prometheus:
          address: http://prometheus-operated.monitoring:9090
          query: >+
            100 * (sum(rate(container_cpu_usage_seconds_total{pod="{{args.podname}}"}[5m])) by (pod) / sum(kube_pod_container_resource_limits{pod=~"{{args.podname}}", resource="cpu"}) by (pod))
